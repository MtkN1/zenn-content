---
title: "クラウドにデプロイ"
---

この章ではクラウド環境でのレガシーなデプロイコンセプトを紹介します。

## クラウド環境について

bot を継続的に稼働させる為には、所謂 AWS のようなクラウド上の仮想マシンを利用して bot を実行します。 AWS であれば **EC2 インスタンス**を作成する必要があります。

https://aws.amazon.com/jp/ec2/

こちらは AWS ユーザーガイドによるインスタンス作成手順ですが、普段から AWS を利用している方はこのようにインスタンスの作成には手馴れている方も多いのではないでしょうか。

![](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/images/tutorial-launch-instance.gif)

https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/option3-task1-launch-ec2-instance.html


## 環境構築について

**この本ではインスタンス作成や環境構築に関する詳細は省略します**。

ただし抑えておく必要があるのは、**作成した仮想マシンにてデプロイ作業を実施する為の最低限の接続方法**です。

仮想マシンには基本的に **SSH** を利用して接続を行います。 ここでは **SSH** を利用する為の手段を 2 つ紹介します。

### ターミナルから ssh コマンドを利用する

AWS とローカルで SSH の鍵の適切な設定を行ったら `ssh` コマンドで仮想マシンに接続することが可能です。

![](https://storage.googleapis.com/zenn-user-upload/59682f6b72d5-20231215.png)

SSH 接続後、ターミナルからデプロイ作業を行うことが可能です。

### VS Code の SSH 拡張機能を利用する

エディタとして VS Code を利用しているのであれば SSH 拡張機能を利用して、**VS Code 上で仮想マシンに接続することが可能です**。 デプロイだけではなく、**ローカル環境と同じようにコード編集ができるのでそのまま bot を開発して実行することが可能**です。

![](https://code.visualstudio.com/assets/docs/remote/ssh-tutorial/debug-view.png)

https://code.visualstudio.com/docs/remote/ssh

環境構築についてのまとまった記事としては以前こちらの note を書きました。 **今回の本ではより発展したデプロイコンセプトを紹介しますが**、インスタンスの作成や環境構築についての手順などは note で詳しく説明しているので参考になる点があるかもせれません。

https://note.com/mtkn1/n/nbc33e765558b

## nohup や tmux でデプロイ

クラウド環境を利用することで、仮想マシン自体は常時稼働してくれます。 しかし仮想マシン上で `python main.py`　のコマンドを実行することでデプロイが完了すると思いきや実はそうではありません。

コマンドを実行中の状態で SSH 接続を抜ける (ターミナルウィンドウを閉じたりする) とそのコマンドは終了してしまいます。 これはフォアグラウンドという状態で実行している為です。 それを避けるために `nohup` や `tmux` コマンドを利用して**バックグラウンド**でプログラムを実行します。

```bash:nohup
$ nohup python main.py &
```

```bash:tmux
$ tmux
# tmux の仮想端末が起動される
$ python main.py
```

`nuhup` ついては以前コラム的にこちらの note を書きました。 前半で nohup や tmux の紹介をしています。 後半についてはこの本の草案的な内容となっています。

https://note.com/mtkn1/n/n1bc508855801

以上でクラウド環境の仮想マシンにおいて bot をデプロイできるようになりました 🚀

## まとめ

クラウド環境を利用することで、ローカルと比較して以下の課題を解決できます。 しかし解決できない課題と、新たな課題も浮かび上がってきます。

- **可用性**
    - ✅ PC の電源を付けっぱなしにしなくても bot を常時稼働できる。
    - 🤔 (**New**) bot を稼働させている仮想マシンを開発に併用するとサーバー自体が落ちる可能性がある。
- **ネットワーキング**
    - ✅ 個人のインターネット環境に左右されない。
- **運用性**
    - 🤔 nohup や tmux だと外部から bot のログ確認や一時停止等の管理を行うことはまだ簡単ではない。
    - 🤔 (**New**) 開発している環境と稼働させている環境が分離すると bot のソースを更新したらバージョンの管理が大変になる。
- **可搬性**
    - 🤔 新しいインスタンスや別リージョンのインスタンスで bot を稼働させたい時など、ライブラリが環境に依存している場合、別環境で環境構築するのは容易ではない。

次の章ではバージョン管理システムである Git/GitHub を利用することで **バージョニング** を解決することで、正しく環境を分離したより **可用性** の高い構成で bot をデプロイしていきましょう。
