---
title: "レガシーなデプロイ"
---

この章ではレガシーなデプロイコンセプトを概要のみ紹介します。

## ローカル環境

初めの章で紹介したように、ローカルで次のコマンドを実行して PC の電源を付けっぱなしにしておく事で「bot を稼働させる」という目的自体は達成できます。

![](https://storage.googleapis.com/zenn-user-upload/427d60900661-20231214.png)

非常にシンプルで手っ取り早いです。 多くの人は VS Code などのターミナルが統合されているエディタを利用していると思いますので、そこでコマンドを実行する (もしくは実行ボタンを押す) だけです。 しかし、パッと思いつく限りでも様々な問題があります。

- **可用性**
    - 🤔 PC の電源を付けっぱなしにしておかなくてはいけない。
    - 🤔 PC をシャットダウンしたら bot も停止する。
    - 🤔 PC のスペックを超える処理を行うことができない。
- **ネットワーキング**
    - 🤔 通信が個人のインターネット環境に左右される。
- **モニタリング**
    - 🤔 出先などで外部から bot のログ確認や一時停止等の管理を行うことが難しい。
- **可搬性**
    - 🤔 ライブラリなどがローカルの環境に依存している場合、別環境で bot が実行できない可能性がある。

開発中にローカルで一時的に実行してテストするというぐらいのケースであれば問題ないのですが、実際に継続的に bot を稼働させようとすることは難しいです。

その為、既にクラウド環境を利用している botter は多いかと思います。 クラウド環境を利用することで主に可用性やネットワーキングの問題を解決することができます。

## クラウド環境

所謂 AWS EC2 のようなクラウド上の仮想マシンで bot を実行します。

https://aws.amazon.com/jp/ec2/

仮想マシンを利用するには、AWS であれば EC2 インスタンスを作成する必要があります。 こちらは AWS のユーザーガイドによるインスタンス作成手順の GIF アニメーションですが、普段から AWS を利用している方はこのようにインスタンスの作成には手馴れている方も多いのではないでしょうか。

![](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/images/tutorial-launch-instance.gif)

https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/option3-task1-launch-ec2-instance.html

クラウド環境でのデプロイコンセプトとしては、ローカル環境で行っていた作業を同じことを仮想マシンで実行するだけです。 ※仮想マシンの環境構築が必要です。

仮想マシンには通常 **SSH** 接続を利用します。 AWS とローカルで適切な設定を行ったら、ローカルから ssh コマンドで仮想マシンに接続することで作業を行うことができます。

![](https://storage.googleapis.com/zenn-user-upload/59682f6b72d5-20231215.png)

また VS Code であれば SSH 拡張機能が存在するので、**VS Code 上で仮想マシンに接続してローカル環境と同じようにコード編集して bot を実行することが可能**です。

![](https://code.visualstudio.com/assets/docs/remote/ssh-tutorial/debug-view.png)

https://code.visualstudio.com/docs/remote/ssh

この本を書く 2 年前にこのコンセプトについての詳しい手順を note で書きました。

https://note.com/mtkn1/n/nbc33e765558b
### nohup と tmux

仮想マシン自体は常時稼働し続けていますが、コマンドを実行中の状態で SSH 接続を抜けるとそのコマンドは終了してしまいます。 それを避けるために `nuhup` や `tmux` コマンドを利用します。

これについてはこの本を書く半年前に note を書きました。 前半で nohup や tmux を解説しています。 後半についてはこの本の草案的な内容となっているので斜め読み推奨です。

https://note.com/mtkn1/n/n1bc508855801

以上でクラウド環境の仮想マシンにおいて bot をデプロイできるようになりました 🚀

### 開発環境と稼働環境の併用について

ただし bot を稼働させているサーバーで同時に開発を行うと、余計なリソースを消費するなどして可用性が落ちるなど新たな課題があります。 つまり開発に併用しているせいでサーバーが**リソース不足に陥ってしまい bot が停止する可能性がある**ということです。

実際 VS Code の SSH 拡張機能は、2 コア CPU と 2 GB RAM を推奨しています。

> 1 GB RAM is required for remote hosts, but at least 2 GB RAM and a 2-core CPU is recommended.
> 
> https://code.visualstudio.com/docs/remote/ssh#_system-requirements

AWS EC2 でこの要件を満たす最低インスタンスは t3.small です。

![](https://storage.googleapis.com/zenn-user-upload/a6c1c9d29e11-20231215.png)

t3.small は料金としては **2,897 円/月** 以上掛かります。

https://aws-rough.cc/ec2/?z=14324aa95f84ab37c889

費用を回収できる bot を持っているのであれば全く問題はありませんが、bot ビギナーだったり AWS の無料枠の t2.micro で試している方にとっては**料金的にも少し敷居が高い**かもしれません。

:::message
ただしこの金額レベルでは個人差はあるのでこの本において課題としては扱いません。
:::

通常のソフトウェア開発の文脈でも本番環境等で開発を行うことはありません。 特に上記可用性の観点からも**開発環境と稼働環境は積極的に分けるべき**です。 この章では目標を分かりやすくするために、ローカル環境で行っていた作業をクラウド環境で同じように行うことで課題を解決するといった観点で説明をしました。

## まとめ

クラウド環境を利用することで、ローカルと比較して以下の課題を解決できます。 しかし解決できない課題と新たな課題もあります。

- **可用性**
    - ✅ PC の電源を付けっぱなしにしなくても bot を常時稼働できる。
    - 🤔 (**New**) bot を稼働させている仮想マシンを開発に併用するとサーバー自体が落ちる可能性がある。
- **ネットワーキング**
    - ✅ 個人のインターネット環境に左右されない。
- **モニタリング**
    - 🤔 nohup や tmux だと外部から bot のログ確認や一時停止等の管理を行うことはまだ簡単ではない。
- **可搬性**
    - 🤔 別リージョンのインスタンスで bot を稼働させたい場合など、ライブラリなどが環境に依存している場合、環境構築が容易ではない。
- **バージョニング**
    - 🤔 (**New**) 開発している環境と稼働させている環境が分離すると bot のソースを更新したらバージョンの管理が大変になる。

次の章ではバージョン管理システムである Git/GitHub を利用することで **バージョニング** を解決することで、正しく環境を分離したより **可用性** の高い構成で bot をデプロイしていきましょう。
